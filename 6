- name: Read ls -ltr output from file.txt
  shell: cat /path/to/file.txt
  register: ls_output

- name: Generate revert.sh script
  copy:
    dest: /path/to/revert.sh
    content: |
      {% for line in ls_output.stdout_lines %}
      {% if line|length > 1 %}
      {% set parts = line.split() %}
      {% set perms = parts[0] %}
      {% set file = parts[8] %}
      chmod {{ perms }} "{{ file }}"
      {% endif %}
      {% endfor %}
    mode: '0755'
  when: ls_output.stdout_lines|length > 0
